---
description: testã‚„lintã®å®Ÿè¡Œãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚
alwaysApply: false
---
# Rust WebAPI - Lint & Testå®Ÿè¡Œã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Rustãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹lintã¨testå®Ÿè¡Œã®çµ±ä¸€ãƒ«ãƒ¼ãƒ«ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚

## ğŸ” Lintå®Ÿè¡Œ

### åŸºæœ¬çš„ãªlintã‚³ãƒãƒ³ãƒ‰

```bash
# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆ--checkãƒ•ãƒ©ã‚°ã§å®Ÿéš›ã®å¤‰æ›´ãªã—ï¼‰
cargo fmt --all -- --check

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œ
cargo fmt --all

# Clippyã«ã‚ˆã‚‹lintãƒã‚§ãƒƒã‚¯
cargo clippy -- -D warnings

# ã‚ˆã‚Šå³å¯†ãªClippyãƒã‚§ãƒƒã‚¯
cargo clippy --all-targets --all-features -- -D warnings -W clippy::all -W clippy::pedantic
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®Clippyè¨­å®š

```toml
# Cargo.tomlã¾ãŸã¯.clippy.tomlã«è¿½åŠ 
[workspace.lints.clippy]
# ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†lint
enum_glob_use = "deny"
unwrap_used = "deny"
expect_used = "deny"

# è­¦å‘Šã¨ã—ã¦æ‰±ã†lint
missing_docs_in_private_items = "warn"
missing_const_for_fn = "warn"

# è¨±å¯ã™ã‚‹lint
module_name_repetitions = "allow"
must_use_candidate = "allow"
```

### rustfmtè¨­å®šï¼ˆrustfmt.tomlï¼‰

```toml
# rustfmt.toml
edition = "2021"
max_width = 100
tab_spaces = 4
use_small_heuristics = "Default"
imports_granularity = "Crate"
group_imports = "StdExternalCrate"
reorder_imports = true
reorder_modules = true
remove_nested_parens = true
use_field_init_shorthand = true
use_try_shorthand = true
format_code_in_doc_comments = true
```

## ğŸ§ª Testå®Ÿè¡Œ

### åŸºæœ¬çš„ãªtestã‚³ãƒãƒ³ãƒ‰

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cargo test

# ä¸¦è¡Œå®Ÿè¡Œæ•°ã‚’åˆ¶é™ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆæ™‚ã«æ¨å¥¨ï¼‰
cargo test -- --test-threads=1

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
cargo test test_create_user

# ãƒ†ã‚¹ãƒˆå‡ºåŠ›ã‚’è¡¨ç¤º
cargo test -- --nocapture

# å¤±æ•—æ™‚ã«å³åº§ã«åœæ­¢
cargo test -- --fail-fast

# ãƒªãƒªãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆ
cargo test --release
```

### ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒªåˆ¥å®Ÿè¡Œ

```bash
# å˜ä½“ãƒ†ã‚¹ãƒˆã®ã¿
cargo test --lib

# çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿
cargo test --test '*'

# ç‰¹å®šã®çµ±åˆãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
cargo test --test integration_tests

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
cargo test --doc

# å…¨ç¨®é¡ã®ãƒ†ã‚¹ãƒˆ
cargo test --all-targets
```

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š

```bash
# tarpaulinã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
cargo install cargo-tarpaulin
cargo tarpaulin --out Html --output-dir coverage

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’CIã§ä½¿ç”¨
cargo tarpaulin --out Xml

# ã‚ˆã‚Šè©³ç´°ãªè¨­å®š
cargo tarpaulin \
  --out Html \
  --output-dir coverage \
  --exclude-files "*/tests/*" \
  --exclude-files "*/target/*" \
  --ignore-panics \
  --timeout 300
```

## ğŸ“‹ å®Ÿè¡Œå‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚³ãƒŸãƒƒãƒˆå‰ã«å®Ÿè¡Œã™ã¹ãã‚³ãƒãƒ³ãƒ‰

```bash
#!/bin/bash
# scripts/pre-commit.sh

echo "ğŸ” Running format check..."
cargo fmt --all -- --check || exit 1

echo "ğŸ“ Running clippy..."
cargo clippy --all-targets --all-features -- -D warnings || exit 1

echo "ğŸ§ª Running tests..."
cargo test || exit 1

echo "âœ… All checks passed!"
```

### Git pre-commitãƒ•ãƒƒã‚¯è¨­å®š

```bash
# .git/hooks/pre-commit
#!/bin/sh
./scripts/pre-commit.sh
```

## ğŸš€ CI/CDçµ±åˆ

### GitHub Actionsè¨­å®šä¾‹

```yaml
name: Rust CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run Clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Run migrations
      run: |
        cargo install sqlx-cli --no-default-features --features rustls,postgres
        sqlx migrate run
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
    
    - name: Run tests
      run: cargo test --all-features
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
        RUST_LOG: debug
    
    - name: Generate coverage report
      run: |
        cargo install cargo-tarpaulin
        cargo tarpaulin --out Xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: true
```

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. æ®µéšçš„ãªãƒã‚§ãƒƒã‚¯

```bash
# é–‹ç™ºä¸­ã®é »ç¹ãªãƒã‚§ãƒƒã‚¯
cargo check          # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼ˆé«˜é€Ÿï¼‰
cargo clippy         # åŸºæœ¬çš„ãªlint

# ã‚³ãƒŸãƒƒãƒˆå‰ã®å®Œå…¨ãƒã‚§ãƒƒã‚¯
cargo fmt --all
cargo clippy --all-targets --all-features -- -D warnings
cargo test
```

### 2. ä¸¦åˆ—å®Ÿè¡Œã®æ´»ç”¨

```bash
# cargo-nextestï¼ˆé«˜é€Ÿãªãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ï¼‰
cargo install cargo-nextest
cargo nextest run

# ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰è¨­å®š
export CARGO_BUILD_JOBS=8
```

### 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨

```toml
# .cargo/config.toml
[build]
target-dir = "target"
incremental = true

[profile.dev]
incremental = true

[profile.test]
incremental = true
```

### 4. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®è‡ªå‹•åŒ–

```bash
# cargo-watchã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•å®Ÿè¡Œ
cargo install cargo-watch

# ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«è‡ªå‹•ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cargo watch -x test

# ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«è‡ªå‹•ã§lintå®Ÿè¡Œ
cargo watch -x "clippy -- -D warnings"
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

1. **Clippyã®è­¦å‘ŠãŒå¤šã™ãã‚‹å ´åˆ**
   ```toml
   # ç‰¹å®šã®lintã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
   #![allow(clippy::too_many_arguments)]
   ```

2. **ãƒ†ã‚¹ãƒˆãŒé…ã„å ´åˆ**
   ```bash
   # ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
   cargo test --release -- --test-threads=4
   
   # ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
   cargo test test_pattern
   ```

3. **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ç«¶åˆ**
   ```bash
   # rustfmtã®è¨­å®šã‚’çµ±ä¸€
   rustup component add rustfmt
   cargo fmt --all
   ```

## ğŸ“Š å“è³ªæŒ‡æ¨™

### ç›®æ¨™å€¤
- **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: 80%ä»¥ä¸Š
- **Clippyè­¦å‘Š**: 0
- **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé•å**: 0
- **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“**: 5åˆ†ä»¥å†…

### æ¸¬å®šã‚³ãƒãƒ³ãƒ‰

```bash
# ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã‚’è¡¨ç¤º
cargo tarpaulin --print-summary

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
cargo test --release -- --nocapture bench

# ãƒ“ãƒ«ãƒ‰æ™‚é–“æ¸¬å®š
cargo build --timings
```

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **[testing-strategy.mdc](mdc:testing-strategy.mdc)** - ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®è©³ç´°
- **[development-guidelines.mdc](mdc:development-guidelines.mdc)** - é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- **[Cargo.toml](mdc:Cargo.toml)** - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
- **[.github/workflows](mdc:.github/workflows)** - CI/CDè¨­å®š


