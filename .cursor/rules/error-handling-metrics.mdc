---
description:
globs:
alwaysApply: false
---
# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹çµ±ä¸€ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Phase 3ã§å®Ÿè£…ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã®çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’èª¬æ˜ã—ã¾ã™ã€‚ä¸€è²«æ€§ã®ã‚ã‚‹ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨è¦³æ¸¬æ€§ã®å‘ä¸Šã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ¯ ç›®çš„

- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€**: `AppError`ã«ã‚ˆã‚‹ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼å‡¦ç†
- **ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã®æ¨™æº–åŒ–**: çµ±ä¸€ã•ã‚ŒãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹APIã®ä½¿ç”¨
- **è¦³æ¸¬æ€§ã®å‘ä¸Š**: tracingã¨ã®çµ±åˆã«ã‚ˆã‚‹è©³ç´°ãªãƒ­ã‚°è¨˜éŒ²
- **ä¿å®ˆæ€§ã®å‘ä¸Š**: é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®å‰Šæ¸›ã¨å¯èª­æ€§ã®å‘ä¸Š

## ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€

### AppError ã®ä½¿ç”¨

ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã¯ [src/infrastructure/error.rs](mdc:src/infrastructure/error.rs) ã§å®šç¾©ã•ã‚ŒãŸ `AppError` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

#### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
use crate::infrastructure::error::{AppError, AppResult};

// åŸºæœ¬çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
pub async fn find_by_id(&self, id: u64) -> AppResult<ItemResponse> {
    let item = self.repository.find_by_id(id).await?;
    match item {
        Some(item) => Ok(self.to_response(item)),
        None => Err(AppError::not_found("Item", id)),
    }
}

// ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã®ä½¿ç”¨
AppError::not_found("User", user_id)
AppError::validation_error("Invalid email format")
AppError::internal_error("Database connection failed")
```

#### âŒ ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
// unwrap/expect ã®ä½¿ç”¨ï¼ˆæœ¬ç•ªã‚³ãƒ¼ãƒ‰ã§ã¯ç¦æ­¢ï¼‰
let item = repository.find_by_id(id).await.unwrap();

// ç›´æ¥çš„ãªã‚¨ãƒ©ãƒ¼æ§‹ç¯‰ï¼ˆãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã¹ãï¼‰
Err(AppError::NotFound(format!("Item with id {} not found", id)))

// anyhow::Error ã®ç›´æ¥ä½¿ç”¨ï¼ˆAppErrorã«å¤‰æ›ã™ã¹ãï¼‰
return Err(anyhow::anyhow!("Something went wrong"));
```

### ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¨™æº–åŒ–

APIã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ä»¥ä¸‹ã®å½¢å¼ã§çµ±ä¸€ã•ã‚Œã¦ã„ã¾ã™ï¼š

```json
{
  "type": "NotFound",
  "message": "Item with id 123 not found",
  "timestamp": "2024-12-01T12:00:00Z"
}
```

## ğŸ“Š ãƒ¡ãƒˆãƒªã‚¯ã‚¹çµ±ä¸€

### çµ±ä¸€ãƒ¡ãƒˆãƒªã‚¯ã‚¹API

[src/infrastructure/metrics/mod.rs](mdc:src/infrastructure/metrics/mod.rs) ã§å®šç¾©ã•ã‚ŒãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

#### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
use crate::infrastructure::metrics::Metrics;

// Resultå‹ã®è‡ªå‹•æˆåŠŸ/å¤±æ•—è¨˜éŒ²
pub async fn find_by_id(&self, id: u64) -> AppResult<ItemResponse> {
    Metrics::with_metrics("item", "find_by_id", async {
        let item = self.repository.find_by_id(id).await?;
        match item {
            Some(item) => Ok(self.to_response(item)),
            None => Err(AppError::not_found("Item", id)),
        }
    }).await
}

// è‡ªå‹•æ™‚é–“æ¸¬å®š
pub async fn create(&self, req: CreateRequest) -> AppResult<Response> {
    Metrics::with_timer("service", "create", async {
        // å‡¦ç†...
        result
    }).await
}

// å€‹åˆ¥è¨˜éŒ²
Metrics::record_success("service", "operation");
Metrics::record_error("service", "operation");
```

#### MetricsTimer ã®ä½¿ç”¨

```rust
use crate::infrastructure::metrics::MetricsTimer;

pub async fn complex_operation(&self) -> AppResult<()> {
    let timer = MetricsTimer::new("service", "complex_operation");
    
    // è¤‡é›‘ãªå‡¦ç†...
    
    timer.observe(); // æ‰‹å‹•ã§è¨˜éŒ²
    // ã¾ãŸã¯ Dropæ™‚ã«è‡ªå‹•è¨˜éŒ²
    Ok(())
}
```

#### âŒ ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
// å¤ã„ãƒ¡ãƒˆãƒªã‚¯ã‚¹APIã®ç›´æ¥ä½¿ç”¨ï¼ˆçµ±ä¸€APIã‚’ä½¿ç”¨ã™ã¹ãï¼‰
increment_success_counter("service", "operation");
increment_error_counter("service", "operation");

// ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã®æ¼ã‚Œ
pub async fn operation(&self) -> AppResult<()> {
    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ãªã—
    self.repository.do_something().await
}
```

## ğŸ” å®Ÿè£…ä¾‹

### ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ã®çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³

[src/application/service/item_service.rs](mdc:src/application/service/item_service.rs) ã®å®Ÿè£…ä¾‹ï¼š

```rust
impl ItemService {
    pub async fn find_all(&self) -> AppResult<Vec<ItemResponse>> {
        Metrics::with_metrics("item", "find_all", async {
            let items = self.repository.find_all().await?;
            Ok(items
                .into_iter()
                .map(|item| self.to_response(item))
                .collect())
        }).await
    }

    pub async fn create(&self, req: CreateItemRequest) -> AppResult<ItemResponse> {
        Metrics::with_metrics("item", "create", async {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            self.validate_create_request(&req)?;
            
            // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä½œæˆ
            let item = Item::new(req.name, req.description);
            
            // ãƒªãƒã‚¸ãƒˆãƒªå‘¼ã³å‡ºã—
            let created_item = self.repository.create(item).await?;
            
            Ok(self.to_response(created_item))
        }).await
    }
}
```

### ãƒãƒƒãƒå‡¦ç†ã§ã®å€‹åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²

```rust
pub async fn batch_delete(&self, req: BatchDeleteRequest) -> AppResult<BatchDeleteResponse> {
    let timer = MetricsTimer::new("item", "batch_delete");
    
    let successful_ids = self.repository.batch_delete(req.ids, req.is_physical).await?;
    let failed_ids: Vec<u64> = req.ids
        .into_iter()
        .filter(|id| !successful_ids.contains(id))
        .collect();

    // å€‹åˆ¥ã«æˆåŠŸ/å¤±æ•—ã‚’ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«è¨˜éŒ²
    if !successful_ids.is_empty() {
        Metrics::record_success("item", "batch_delete");
    }
    if !failed_ids.is_empty() {
        Metrics::record_error("item", "batch_delete");
    }

    timer.observe();
    Ok(BatchDeleteResponse { successful_ids, failed_ids })
}
```

## ğŸ“ ãƒ­ã‚°çµ±åˆ

### tracing ã¨ã®çµ±åˆ

ãƒ¡ãƒˆãƒªã‚¯ã‚¹APIã¯è‡ªå‹•çš„ã«tracingãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™ï¼š

```rust
// è‡ªå‹•çš„ã«ä»¥ä¸‹ã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹
// DEBUG: Metrics: item find_by_id success
// DEBUG: Metrics: item find_by_id duration: 0.025s
// WARN:  Metrics: item find_by_id error
```

### æ§‹é€ åŒ–ãƒ­ã‚°ã®æ´»ç”¨

```rust
use tracing::{info, warn, error};

pub async fn operation(&self, id: u64) -> AppResult<()> {
    info!(operation = "start", entity_id = id, "Starting operation");
    
    let result = Metrics::with_metrics("service", "operation", async {
        // å‡¦ç†...
        Ok(())
    }).await;
    
    match &result {
        Ok(_) => info!(operation = "complete", entity_id = id, "Operation completed"),
        Err(e) => error!(operation = "failed", entity_id = id, error = %e, "Operation failed"),
    }
    
    result
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
#[tokio::test]
async fn test_find_by_id_not_found() {
    let mut mock_repo = MockItemRepository::new();
    mock_repo
        .expect_find_by_id()
        .with(eq(999u64))
        .return_once(|_| Ok(None));

    let service = ItemService::new(Arc::new(mock_repo));
    let result = service.find_by_id(999).await;

    // AppErrorã®ç‰¹å®šã®å‹ã‚’ãƒ†ã‚¹ãƒˆ
    assert!(matches!(result, Err(AppError::NotFound(_))));
}
```

## ğŸ”§ ç§»è¡Œã‚¬ã‚¤ãƒ‰

### æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ç§»è¡Œæ‰‹é †

1. **ã‚¨ãƒ©ãƒ¼å‹ã®çµ±ä¸€**
   ```rust
   // Before
   return Err(anyhow::anyhow!("Not found"));
   
   // After
   return Err(AppError::not_found("Entity", id));
   ```

2. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã®çµ±ä¸€**
   ```rust
   // Before
   increment_success_counter("service", "operation");
   
   // After
   Metrics::with_metrics("service", "operation", async {
       // å‡¦ç†...
   }).await
   ```

3. **unwrap/expect ã®é™¤å»**
   ```rust
   // Before
   let item = repository.find_by_id(id).await.unwrap();
   
   // After
   let item = repository.find_by_id(id).await?;
   ```

## ğŸ“Š ãƒ¡ãƒˆãƒªã‚¯ã‚¹å‡ºåŠ›å½¢å¼

### Prometheuså½¢å¼

```
# HELP api_success_total Total number of successful API requests
# TYPE api_success_total counter
api_success_total{service="item",endpoint="find_by_id"} 42

# HELP api_error_total Total number of API errors
# TYPE api_error_total counter
api_error_total{service="item",endpoint="find_by_id"} 3

# HELP api_request_duration_seconds API request duration in seconds
# TYPE api_request_duration_seconds histogram
api_request_duration_seconds_bucket{service="item",endpoint="find_by_id",le="0.005"} 10
api_request_duration_seconds_bucket{service="item",endpoint="find_by_id",le="0.01"} 25
api_request_duration_seconds_sum{service="item",endpoint="find_by_id"} 1.234
api_request_duration_seconds_count{service="item",endpoint="find_by_id"} 45
```

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### Do's

- âœ… `AppError`ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
- âœ… `Metrics::with_metrics`ã§è‡ªå‹•è¨˜éŒ²
- âœ… `MetricsTimer`ã§æ™‚é–“æ¸¬å®š
- âœ… æ§‹é€ åŒ–ãƒ­ã‚°ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è¨˜éŒ²
- âœ… ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼å‹ã‚’æ˜ç¤ºçš„ã«æ¤œè¨¼

### Don'ts

- âŒ æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã§`unwrap`/`expect`ã‚’ä½¿ç”¨
- âŒ å¤ã„ãƒ¡ãƒˆãƒªã‚¯ã‚¹APIã‚’ç›´æ¥ä½¿ç”¨
- âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›´æ¥æ§‹ç¯‰
- âŒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã‚’å¿˜ã‚Œã‚‹
- âŒ ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’é©åˆ‡ã«è¨­å®šã—ãªã„

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **[src/infrastructure/error.rs](mdc:src/infrastructure/error.rs)** - AppErrorå®šç¾©
- **[src/infrastructure/metrics/mod.rs](mdc:src/infrastructure/metrics/mod.rs)** - ãƒ¡ãƒˆãƒªã‚¯ã‚¹API
- **[src/application/service/item_service.rs](mdc:src/application/service/item_service.rs)** - å®Ÿè£…ä¾‹
- **[src/application/service/user_service.rs](mdc:src/application/service/user_service.rs)** - å®Ÿè£…ä¾‹
- **[REMAINING_IMPROVEMENTS.md](mdc:REMAINING_IMPROVEMENTS.md)** - Phase 3å®Œäº†çŠ¶æ³

---

ã“ã®ã‚¬ã‚¤ãƒ‰ã«å¾“ã†ã“ã¨ã§ã€ä¸€è²«æ€§ã®ã‚ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã‚’å®Ÿç¾ã—ã€ä¿å®ˆæ€§ã¨è¦³æ¸¬æ€§ã®é«˜ã„Rust WebAPIã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
