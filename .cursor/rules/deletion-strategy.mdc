---
description:
globs:
alwaysApply: false
---
# å‰Šé™¤æˆ¦ç•¥çµ±ä¸€ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Phase 2-3ã§å®Ÿè£…ã•ã‚ŒãŸå‰Šé™¤æ“ä½œã®çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’èª¬æ˜ã—ã¾ã™ã€‚æˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ´»ç”¨ã—ãŸä¸€è²«æ€§ã®ã‚ã‚‹å‰Šé™¤å‡¦ç†ã®å®Ÿç¾æ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ¯ ç›®çš„

- **å‰Šé™¤æ“ä½œã®çµ±ä¸€**: æˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹æŸ”è»Ÿãªå‰Šé™¤æ–¹æ³•ã®é¸æŠ
- **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®çµ±ä¸€**: ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹çµ±ä¸€ã•ã‚ŒãŸAPI
- **ä¿å®ˆæ€§ã®å‘ä¸Š**: å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯ã®é›†ç´„ã¨é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®å‰Šæ¸›
- **æ‹¡å¼µæ€§ã®ç¢ºä¿**: æ–°ã—ã„å‰Šé™¤æˆ¦ç•¥ã®å®¹æ˜“ãªè¿½åŠ 

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```
Presentation Layer (API Handlers)
        â†“
Application Layer (DeletionFacade)
        â†“
Domain Layer (DeletionStrategy)
        â†“
Infrastructure Layer (Repositories)
```

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- **DeletionStrategy**: å‰Šé™¤æˆ¦ç•¥ã®æŠ½è±¡åŒ–
- **DeletionFacade**: è¤‡æ•°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- **DeleteKind**: å‰Šé™¤æ–¹æ³•ã®ç¨®é¡ï¼ˆLogical/Physical/Restoreï¼‰

## ğŸ­ æˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…

### DeletionStrategy ãƒˆãƒ¬ã‚¤ãƒˆ

[src/app_domain/service/deletion_service.rs](mdc:src/app_domain/service/deletion_service.rs) ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼š

```rust
#[async_trait]
pub trait DeletionStrategy: Send + Sync {
    async fn delete(&self, id: u64, kind: DeleteKind) -> Result<(), DeletionError>;
}

#[derive(Debug, Clone, Copy)]
pub enum DeleteKind {
    Logical,    // è«–ç†å‰Šé™¤ï¼ˆdeleted ãƒ•ãƒ©ã‚°ã‚’ true ã«è¨­å®šï¼‰
    Physical,   // ç‰©ç†å‰Šé™¤ï¼ˆãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«å‰Šé™¤ï¼‰
    Restore,    // å¾©å…ƒï¼ˆdeleted ãƒ•ãƒ©ã‚°ã‚’ false ã«è¨­å®šï¼‰
}
```

### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

#### 1. æˆ¦ç•¥ã®å®Ÿè£…

```rust
pub struct ItemDeletionStrategy {
    repository: Arc<dyn ItemRepository + Send + Sync>,
}

#[async_trait]
impl DeletionStrategy for ItemDeletionStrategy {
    async fn delete(&self, id: u64, kind: DeleteKind) -> Result<(), DeletionError> {
        match kind {
            DeleteKind::Logical => {
                self.repository.logical_delete(id).await
                    .map_err(|e| DeletionError::from_app_error(e))
            }
            DeleteKind::Physical => {
                self.repository.physical_delete(id).await
                    .map_err(|e| DeletionError::from_app_error(e))
            }
            DeleteKind::Restore => {
                self.repository.restore(id).await
                    .map_err(|e| DeletionError::from_app_error(e))
            }
        }
    }
}
```

#### 2. ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ã®ä½¿ç”¨

```rust
use crate::application::service::deletion_facade::DeletionFacade;

// API ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ã®ä½¿ç”¨
pub async fn delete_item(
    data: web::Data<AppState>,
    path: web::Path<u64>,
    query: web::Query<DeleteQuery>,
) -> Result<HttpResponse, Error> {
    let id = path.into_inner();
    let kind = query.kind.unwrap_or(DeleteKind::Logical);
    
    data.deletion_facade.delete_item(id, kind).await?;
    
    Ok(HttpResponse::NoContent().finish())
}
```

## ğŸ›ï¸ ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…

### DeletionFacade

[src/application/service/deletion_facade.rs](mdc:src/application/service/deletion_facade.rs) ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼š

```rust
pub struct DeletionFacade {
    item_strategy: Arc<dyn DeletionStrategy + Send + Sync>,
    category_strategy: Arc<dyn DeletionStrategy + Send + Sync>,
    product_strategy: Arc<dyn DeletionStrategy + Send + Sync>,
}

impl DeletionFacade {
    pub async fn delete_item(&self, id: u64, kind: DeleteKind) -> AppResult<()> {
        self.item_strategy.delete(id, kind).await
            .map_err(|e| e.into())
    }
    
    pub async fn delete_category(&self, id: u64, kind: DeleteKind) -> AppResult<()> {
        self.category_strategy.delete(id, kind).await
            .map_err(|e| e.into())
    }
    
    pub async fn delete_product(&self, id: u64, kind: DeleteKind) -> AppResult<()> {
        self.product_strategy.delete(id, kind).await
            .map_err(|e| e.into())
    }
}
```

## ğŸ”§ å®Ÿè£…ä¾‹

### API ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ã®çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³

#### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
// è«–ç†å‰Šé™¤
#[delete("/items/{id}")]
pub async fn logical_delete_item(
    data: web::Data<AppState>,
    path: web::Path<u64>,
) -> Result<HttpResponse, Error> {
    let id = path.into_inner();
    data.deletion_facade.delete_item(id, DeleteKind::Logical).await?;
    Ok(HttpResponse::NoContent().finish())
}

// ç‰©ç†å‰Šé™¤
#[delete("/items/{id}/permanent")]
pub async fn physical_delete_item(
    data: web::Data<AppState>,
    path: web::Path<u64>,
) -> Result<HttpResponse, Error> {
    let id = path.into_inner();
    data.deletion_facade.delete_item(id, DeleteKind::Physical).await?;
    Ok(HttpResponse::NoContent().finish())
}

// å¾©å…ƒ
#[post("/items/{id}/restore")]
pub async fn restore_item(
    data: web::Data<AppState>,
    path: web::Path<u64>,
) -> Result<HttpResponse, Error> {
    let id = path.into_inner();
    data.deletion_facade.delete_item(id, DeleteKind::Restore).await?;
    Ok(HttpResponse::Ok().json(json!({"message": "Item restored successfully"})))
}
```

#### âŒ ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
// æ—§ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆçµ±ä¸€å‰ï¼‰- ä½¿ç”¨ç¦æ­¢
pub async fn delete_item_old(
    data: web::Data<AppState>,
    path: web::Path<u64>,
) -> Result<HttpResponse, Error> {
    let id = path.into_inner();
    // ç›´æ¥ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ï¼ˆçµ±ä¸€æ€§ãŒãªã„ï¼‰
    data.item_service.delete(id).await?;
    Ok(HttpResponse::NoContent().finish())
}
```

### gRPC ã‚µãƒ¼ãƒ“ã‚¹ã§ã®çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
impl ItemService for ItemServiceImpl {
    async fn delete_item(
        &self,
        request: Request<DeleteItemRequest>,
    ) -> Result<Response<DeleteItemResponse>, Status> {
        let req = request.into_inner();
        let kind = match req.delete_type.as_str() {
            "logical" => DeleteKind::Logical,
            "physical" => DeleteKind::Physical,
            _ => DeleteKind::Logical,
        };
        
        self.deletion_facade.delete_item(req.id, kind).await
            .map_err(|e| Status::internal(e.to_string()))?;
            
        Ok(Response::new(DeleteItemResponse {
            success: true,
            message: "Item deleted successfully".to_string(),
        }))
    }
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

### Contract Test ã®å®Ÿè£…

[tests/contract_deletion_strategy_tests.rs](mdc:tests/contract_deletion_strategy_tests.rs) ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼š

```rust
#[tokio::test]
async fn test_deletion_strategy_logical_delete() {
    let strategy = create_item_deletion_strategy().await;
    
    // è«–ç†å‰Šé™¤ã®å®Ÿè¡Œ
    let result = strategy.delete(1, DeleteKind::Logical).await;
    assert!(result.is_ok());
    
    // å‰Šé™¤çŠ¶æ…‹ã®ç¢ºèª
    // ï¼ˆå®Ÿè£…ã«å¿œã˜ã¦é©åˆ‡ãªæ¤œè¨¼ã‚’è¡Œã†ï¼‰
}

#[tokio::test]
async fn test_deletion_strategy_not_found() {
    let strategy = create_item_deletion_strategy().await;
    
    // å­˜åœ¨ã—ãªã„IDã§å‰Šé™¤ã‚’è©¦è¡Œ
    let result = strategy.delete(999, DeleteKind::Logical).await;
    assert!(matches!(result, Err(DeletionError::NotFound(_))));
}
```

### ãƒ¢ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆ

```rust
#[tokio::test]
async fn test_deletion_facade_item_delete() {
    let mut mock_strategy = MockDeletionStrategy::new();
    mock_strategy
        .expect_delete()
        .with(eq(1u64), eq(DeleteKind::Logical))
        .return_once(|_, _| Ok(()));
    
    let facade = DeletionFacade::new(
        Arc::new(mock_strategy),
        Arc::new(MockDeletionStrategy::new()),
        Arc::new(MockDeletionStrategy::new()),
    );
    
    let result = facade.delete_item(1, DeleteKind::Logical).await;
    assert!(result.is_ok());
}
```

## ğŸ”„ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### DeletionError ã®çµ±ä¸€

```rust
#[derive(Debug, Clone)]
pub enum DeletionError {
    NotFound(String),
    Validation(String),
    Other(String),
}

impl From<DeletionError> for AppError {
    fn from(err: DeletionError) -> Self {
        match err {
            DeletionError::NotFound(msg) => AppError::NotFound(msg),
            DeletionError::Validation(msg) => AppError::ValidationError(msg),
            DeletionError::Other(msg) => AppError::InternalServerError(msg),
        }
    }
}
```

## ğŸš€ æ‹¡å¼µãƒ‘ã‚¿ãƒ¼ãƒ³

### æ–°ã—ã„å‰Šé™¤æˆ¦ç•¥ã®è¿½åŠ 

```rust
// ä¾‹: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‰Šé™¤æˆ¦ç•¥
#[derive(Debug, Clone, Copy)]
pub enum DeleteKind {
    Logical,
    Physical,
    Restore,
    Archive,    // æ–°ã—ã„å‰Šé™¤æ–¹æ³•
}

// æˆ¦ç•¥ã®å®Ÿè£…
pub struct ArchiveDeletionStrategy {
    repository: Arc<dyn ItemRepository + Send + Sync>,
    archive_repository: Arc<dyn ArchiveRepository + Send + Sync>,
}

#[async_trait]
impl DeletionStrategy for ArchiveDeletionStrategy {
    async fn delete(&self, id: u64, kind: DeleteKind) -> Result<(), DeletionError> {
        match kind {
            DeleteKind::Archive => {
                // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†ã®å®Ÿè£…
                let item = self.repository.find_by_id(id).await?;
                self.archive_repository.archive(item).await?;
                self.repository.physical_delete(id).await?;
                Ok(())
            }
            _ => {
                // æ—¢å­˜ã®å‰Šé™¤æ–¹æ³•ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                self.repository.delete(id, kind).await
            }
        }
    }
}
```

## ğŸ“Š ãƒ¡ãƒˆãƒªã‚¯ã‚¹çµ±åˆ

å‰Šé™¤æ“ä½œã§ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š

```rust
impl ItemDeletionStrategy {
    async fn delete(&self, id: u64, kind: DeleteKind) -> Result<(), DeletionError> {
        let operation = format!("delete_{:?}", kind).to_lowercase();
        
        Metrics::with_metrics("deletion", &operation, async {
            match kind {
                DeleteKind::Logical => self.repository.logical_delete(id).await,
                DeleteKind::Physical => self.repository.physical_delete(id).await,
                DeleteKind::Restore => self.repository.restore(id).await,
            }
            .map_err(|e| DeletionError::from_app_error(e))
        }).await
    }
}
```

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### Do's

- âœ… `DeletionFacade` ã‚’é€šã˜ã¦å‰Šé™¤æ“ä½œã‚’å®Ÿè¡Œ
- âœ… `DeleteKind` ã§å‰Šé™¤æ–¹æ³•ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
- âœ… Contract Test ã§å‰Šé™¤æˆ¦ç•¥ã®å‹•ä½œã‚’ä¿è¨¼
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ `DeletionError` ã§çµ±ä¸€
- âœ… ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã‚’å¿˜ã‚Œãšã«å®Ÿè£…

### Don'ts

- âŒ æ—§å‰Šé™¤ãƒ¡ã‚½ãƒƒãƒ‰ã®ç›´æ¥ä½¿ç”¨
- âŒ å‰Šé™¤æˆ¦ç•¥ã‚’ç›´æ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
- âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ä¸çµ±ä¸€
- âŒ ãƒ†ã‚¹ãƒˆã§ã®å‰Šé™¤æˆ¦ç•¥ã®æ¤œè¨¼ä¸è¶³
- âŒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã®æ¼ã‚Œ

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **[src/app_domain/service/deletion_service.rs](mdc:src/app_domain/service/deletion_service.rs)** - DeletionStrategyå®šç¾©
- **[src/application/service/deletion_facade.rs](mdc:src/application/service/deletion_facade.rs)** - DeletionFacadeå®Ÿè£…
- **[src/presentation/api/item_handler.rs](mdc:src/presentation/api/item_handler.rs)** - APIå®Ÿè£…ä¾‹
- **[src/presentation/grpc/item_service.rs](mdc:src/presentation/grpc/item_service.rs)** - gRPCå®Ÿè£…ä¾‹
- **[tests/contract_deletion_strategy_tests.rs](mdc:tests/contract_deletion_strategy_tests.rs)** - Contract Test
- **[REMAINING_IMPROVEMENTS.md](mdc:REMAINING_IMPROVEMENTS.md)** - Phase 2-3å®Œäº†çŠ¶æ³

---

ã“ã®å‰Šé™¤æˆ¦ç•¥çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã†ã“ã¨ã§ã€ä¸€è²«æ€§ãŒã‚ã‚Šæ‹¡å¼µæ€§ã®é«˜ã„å‰Šé™¤æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã€ä¿å®ˆæ€§ã®å‘ä¸Šã¨æ–°æ©Ÿèƒ½ã®å®¹æ˜“ãªè¿½åŠ ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚
