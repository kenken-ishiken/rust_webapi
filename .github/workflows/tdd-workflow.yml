name: TDD Workflow (Red-Green-Refactor)

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'ãƒ†ã‚¹ãƒˆã®ç¨®é¡žã‚’é¸æŠž'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - performance

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  DATABASE_URL: postgresql://postgres:password@localhost:5432/test_db

jobs:
  # Phase 1: Red - ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
  red-phase:
    name: "ðŸ”´ RED Phase - ãƒ†ã‚¹ãƒˆå¤±æ•—ç¢ºèª"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[tdd:red]')
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install dependencies
      run: |
        cargo install cargo-tarpaulin
        cargo install cargo-watch

    - name: Setup database
      run: |
        sudo apt-get install postgresql-client
        PGPASSWORD=password psql -h localhost -U postgres -d test_db -f initdb/01_create_tables.sql

    - name: "ðŸ”´ Run failing tests (expected to fail)"
      run: |
        echo "::group::Domain Layer Tests"
        cargo test --lib domain -- --nocapture || echo "Domain tests failed as expected in RED phase"
        echo "::endgroup::"
        
        echo "::group::Repository Layer Tests"
        cargo test --lib repository -- --nocapture || echo "Repository tests failed as expected in RED phase"
        echo "::endgroup::"
        
        echo "::group::Service Layer Tests"
        cargo test --lib service -- --nocapture || echo "Service tests failed as expected in RED phase"
        echo "::endgroup::"
        
        echo "::group::API Layer Tests"
        cargo test --test integration_test -- --nocapture || echo "API tests failed as expected in RED phase"
        echo "::endgroup::"

    - name: Generate test report
      run: |
        echo "# ðŸ”´ RED Phase Results" >> $GITHUB_STEP_SUMMARY
        echo "ãƒ†ã‚¹ãƒˆãŒæœŸå¾…é€šã‚Šå¤±æ•—ã—ã¾ã—ãŸã€‚æ¬¡ã¯GREEN phaseã§å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY

  # Phase 2: Green - æœ€å°é™ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’é€šã™
  green-phase:
    name: "ðŸŸ¢ GREEN Phase - æœ€å°å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆæˆåŠŸ"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[tdd:green]')
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install dependencies
      run: |
        cargo install cargo-tarpaulin
        cargo install cargo-watch

    - name: Setup database
      run: |
        sudo apt-get install postgresql-client
        PGPASSWORD=password psql -h localhost -U postgres -d test_db -f initdb/01_create_tables.sql

    - name: "ðŸŸ¢ Run tests (should pass with minimal implementation)"
      run: |
        echo "::group::Domain Layer Tests"
        cargo test --lib domain -- --nocapture
        echo "::endgroup::"
        
        echo "::group::Repository Layer Tests"
        cargo test --lib repository -- --nocapture
        echo "::endgroup::"
        
        echo "::group::Service Layer Tests"
        cargo test --lib service -- --nocapture
        echo "::endgroup::"
        
        echo "::group::API Layer Tests"
        cargo test --test integration_test -- --nocapture
        echo "::endgroup::"

    - name: Check code quality (basic)
      run: |
        cargo clippy -- -D warnings
        cargo fmt -- --check

    - name: Generate test coverage
      run: |
        cargo tarpaulin --out xml --output-dir ./coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/cobertura.xml

    - name: Generate test report
      run: |
        echo "# ðŸŸ¢ GREEN Phase Results" >> $GITHUB_STEP_SUMMARY
        echo "ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼æ¬¡ã¯REFACTOR phaseã§ã‚³ãƒ¼ãƒ‰ã‚’æ”¹å–„ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY

  # Phase 3: Refactor - ãƒ†ã‚¹ãƒˆã‚’ä¿ã¡ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰æ”¹å–„
  refactor-phase:
    name: "ðŸ”µ REFACTOR Phase - ãƒ†ã‚¹ãƒˆä¿æŒã§ã‚³ãƒ¼ãƒ‰æ”¹å–„"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[tdd:refactor]')
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install dependencies
      run: |
        cargo install cargo-tarpaulin
        cargo install cargo-watch
        cargo install cargo-audit
        cargo install cargo-outdated

    - name: Setup database
      run: |
        sudo apt-get install postgresql-client
        PGPASSWORD=password psql -h localhost -U postgres -d test_db -f initdb/01_create_tables.sql

    - name: "ðŸ”µ Run all tests (ensuring no regression)"
      run: |
        echo "::group::Full Test Suite"
        cargo test --all -- --nocapture
        echo "::endgroup::"

    - name: Advanced code quality checks
      run: |
        echo "::group::Clippy Analysis"
        cargo clippy --all-targets --all-features -- -D warnings
        echo "::endgroup::"
        
        echo "::group::Format Check"
        cargo fmt -- --check
        echo "::endgroup::"
        
        echo "::group::Security Audit"
        cargo audit
        echo "::endgroup::"
        
        echo "::group::Dependency Check"
        cargo outdated
        echo "::endgroup::"

    - name: Generate comprehensive coverage
      run: |
        cargo tarpaulin --all-features --workspace --timeout 120 --out xml --output-dir ./coverage

    - name: Performance benchmarks
      run: |
        if [ "${{ github.event.inputs.test_type }}" == "performance" ] || [ "${{ github.event.inputs.test_type }}" == "all" ]; then
          echo "::group::Performance Tests"
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆ
          cargo test --release --test performance_tests -- --nocapture || echo "No performance tests found"
          echo "::endgroup::"
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/cobertura.xml

    - name: Generate refactor report
      run: |
        echo "# ðŸ”µ REFACTOR Phase Results" >> $GITHUB_STEP_SUMMARY
        echo "ã‚³ãƒ¼ãƒ‰ã®æ”¹å–„ãŒå®Œäº†ã—ã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã£ã¦ã„ã¾ã™ï¼" >> $GITHUB_STEP_SUMMARY
        echo "## Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All tests passing" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… No clippy warnings" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code formatting consistent" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security audit passed" >> $GITHUB_STEP_SUMMARY

  # å®Œå…¨ãªTDDã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œ
  full-tdd-cycle:
    name: "ðŸ”„ Full TDD Cycle"
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event.inputs.test_type == 'all'
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install dependencies
      run: |
        cargo install cargo-tarpaulin
        cargo install cargo-audit

    - name: Setup database
      run: |
        sudo apt-get install postgresql-client
        PGPASSWORD=password psql -h localhost -U postgres -d test_db -f initdb/01_create_tables.sql

    - name: "ðŸ§ª Unit Tests (Domain Layer)"
      run: |
        echo "::group::Domain Model Tests"
        cargo test --lib app_domain::model -- --nocapture
        echo "::endgroup::"

    - name: "ðŸ§ª Unit Tests (Service Layer)"
      run: |
        echo "::group::Application Service Tests"
        cargo test --lib application::service -- --nocapture
        echo "::endgroup::"

    - name: "ðŸ§ª Integration Tests (Repository Layer)"
      run: |
        echo "::group::Repository Integration Tests"
        cargo test --test repository_tests -- --nocapture
        echo "::endgroup::"

    - name: "ðŸ§ª End-to-End Tests (API Layer)"
      run: |
        echo "::group::API Integration Tests"
        cargo test --test integration_test -- --nocapture
        echo "::endgroup::"

    - name: "ðŸ“Š Code Quality Analysis"
      run: |
        echo "::group::Clippy Analysis"
        cargo clippy --all-targets --all-features -- -D warnings
        echo "::endgroup::"
        
        echo "::group::Format Check"
        cargo fmt -- --check
        echo "::endgroup::"
        
        echo "::group::Security Audit"
        cargo audit
        echo "::endgroup::"

    - name: "ðŸ“ˆ Coverage Report"
      run: |
        cargo tarpaulin --all-features --workspace --timeout 120 --out xml --output-dir ./coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/cobertura.xml

    - name: "ðŸ“‹ Generate TDD Report"
      run: |
        echo "# ðŸ”„ Complete TDD Cycle Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Domain Layer Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Service Layer Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Repository Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… API Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Code Quality" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Clippy: No warnings" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Formatting: Consistent" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security: No vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "TDDã‚µã‚¤ã‚¯ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ–°ã—ã„æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã€å†åº¦REDâ†’GREENâ†’REFACTORã®ã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY

  # å¤±æ•—æ™‚ã®é€šçŸ¥
  notify-failure:
    name: "ðŸ“¢ Test Failure Notification"
    runs-on: ubuntu-latest
    needs: [full-tdd-cycle]
    if: failure()
    
    steps:
    - name: Notify about test failures
      run: |
        echo "# âŒ TDD Workflow Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. æ–°ã—ã„ãƒ†ã‚¹ãƒˆãŒæœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã‚’æ­£ã—ãå®šç¾©ã—ã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
        echo "2. å®Ÿè£…ãŒæœ€å°é™ã§ãƒ†ã‚¹ãƒˆã‚’é€šã™ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
        echo "3. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¸­ã«æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã€TDDã‚µã‚¤ã‚¯ãƒ«ã‚’å†é–‹ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
