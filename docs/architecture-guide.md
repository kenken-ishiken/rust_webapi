# アーキテクチャガイド

このドキュメントでは、Rust WebAPI のアーキテクチャ設計について説明します。

## 目次

- [全体像](#全体像)
- [アーキテクチャ層](#アーキテクチャ層)
- [主要コンポーネント](#主要コンポーネント)
- [データフロー](#データフロー)
- [認証機構](#認証機構)
- [可観測性](#可観測性)

## 全体像

このプロジェクトはドメイン駆動設計（DDD）の原則に基づいた多層アーキテクチャを採用しています。これにより、ビジネスロジックとインフラストラクチャの関心事を分離し、テスト容易性と保守性を高めています。

## アーキテクチャ層

### 1. ドメイン層 (`crates/domain/` および `src/domain/`)

ドメイン層はビジネスロジックの中核を担い、以下のコンポーネントで構成されています：

- **エンティティ**: ビジネスの中心的なオブジェクト（`Item`, `User` など）
- **値オブジェクト**: 不変の値を表現（`Email`, `Password` など）
- **リポジトリインターフェース**: データアクセスの抽象化（トレイト）
- **ドメインサービス**: エンティティを跨ぐロジック

この層はデータベースやフレームワークに依存せず、純粋なRustコードで実装されています。

### 2. アプリケーション層 (`src/application/`)

アプリケーション層はユースケースを実装し、ドメイン層とプレゼンテーション層を仲介します：

- **DTOs（Data Transfer Objects）**: API通信用のデータ構造
- **サービス**: ユースケースの実装
- **バリデーション**: 入力データの検証
- **例外処理**: エラーハンドリングの統一

この層はドメインオブジェクトとDTOの変換、トランザクション管理などを担当します。

### 3. インフラストラクチャ層 (`src/infrastructure/`)

インフラストラクチャ層は外部システムとの連携を担当します：

- **リポジトリ実装**: PostgreSQLを使用したデータアクセス
- **認証**: Keycloakを使用したJWT認証
- **ロギング**: `tracing` を使用した構造化ログ
- **メトリクス**: Prometheusメトリクスの収集
- **設定管理**: 環境変数とコンフィグファイルの管理

この層は具体的な技術選択を含み、ドメイン層をインフラストラクチャから隔離します。

### 4. プレゼンテーション層 (`src/presentation/`)

プレゼンテーション層はAPIのエンドポイントとHTTPインターフェースを提供します：

- **ハンドラ**: HTTPリクエスト/レスポンスの処理
- **ルート定義**: APIエンドポイントのマッピング
- **ミドルウェア**: 認証、ロギング、エラーハンドリング
- **シリアライゼーション**: JSON形式の変換

この層は`actix-web`を使用してRESTful APIを実装しています。

## 主要コンポーネント

### リポジトリ

リポジトリはドメイン層でインターフェース（トレイト）として定義され、インフラストラクチャ層で実装されています：

- `domain::repository::ItemRepository`（トレイト）
- `infrastructure::repository::PostgresItemRepository`（実装）

### サービス

サービスはアプリケーション層にあり、ドメインロジックを協調させてユースケースを実装します：

- `application::service::ItemService`
- `application::service::UserService`

### APIハンドラ

ハンドラはプレゼンテーション層にあり、HTTPリクエストを処理してサービスを呼び出します：

- `presentation::api::ItemHandler`
- `presentation::api::UserHandler`

## データフロー

1. HTTPリクエストがプレゼンテーション層のハンドラに到達
2. ハンドラはリクエストをDTOに変換
3. DTOがアプリケーション層のサービスに渡される
4. サービスはドメインオブジェクトへの変換を行い、ドメインロジックを実行
5. データアクセスが必要な場合、リポジトリインターフェースを介してインフラストラクチャ層と連携
6. 結果がドメインオブジェクトからDTOに変換され、クライアントに返される

## 認証機構

認証はKeycloakと連携したJWTベースの認証を実装しています：

- `infrastructure::auth::keycloak::KeycloakAuth`: Keycloakとの連携
- `infrastructure::auth::middleware`: 認証ミドルウェア

認証フローは以下の通りです：

1. クライアントはKeycloakから認証トークン（JWT）を取得
2. APIリクエストにJWTトークンを付与
3. 認証ミドルウェアがトークンを検証
4. 認証済みユーザー情報がリクエストコンテキストに追加
5. 各ハンドラは必要に応じて認可チェックを実行

## 可観測性

アプリケーションは包括的な可観測性機能を備えています：

- **ロギング**: `tracing`による構造化JSONログ
- **メトリクス**: Prometheusメトリクス（`/api/metrics`エンドポイント）
- **トレーシング**: OpenTelemetryによる分散トレーシング

詳細な可観測性の実装については、[o11y.md](../o11y.md)を参照してください。
