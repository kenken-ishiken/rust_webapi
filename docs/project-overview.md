# Rust WebAPI プロジェクト概要

## プロジェクト概要

本プロジェクトは、Rustで実装されたクラウドネイティブなREST APIサーバーです。ドメイン駆動設計（DDD）の原則に基づき、高速で型安全、かつスケーラブルなWebサービスを提供します。

### 主な特徴

- **高性能**: Rust + Actix-Web + Tokioによる非同期処理
- **型安全**: Rustの型システムによる実行時エラーの最小化
- **クラウドネイティブ**: Docker/Kubernetes対応、12ファクターアプリ準拠
- **可観測性**: OpenTelemetry、Prometheus、構造化ログによる完全な監視
- **セキュア**: JWT認証、Keycloak連携、適切な権限管理
- **テスタブル**: 単体テスト、統合テスト、E2Eテストの完備

## 技術スタック

### コア技術

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| 言語 | Rust | 1.77+ | アプリケーション実装 |
| Webフレームワーク | Actix-Web | 4.4.0 | HTTPサーバー、ルーティング |
| 非同期ランタイム | Tokio | 1.40.0 | 非同期I/O処理 |
| データベース | PostgreSQL | 15+ | データ永続化 |
| ORマッパー | SQLx | 0.8.5 | 型安全なDB操作 |

### 認証・認可

| 技術 | 用途 |
|------|------|
| Keycloak | IDプロバイダー、JWT発行 |
| jsonwebtoken | JWT検証 |
| actix-web-httpauth | HTTPベアラー認証 |

### 可観測性

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| ロギング | tracing | 構造化ログ出力 |
| メトリクス | Prometheus | アプリケーションメトリクス |
| トレーシング | OpenTelemetry | 分散トレーシング |
| APM | Datadog | 本番環境の監視 |

### インフラストラクチャ

| 技術 | 用途 |
|------|------|
| Docker | コンテナ化 |
| Docker Compose | ローカル開発環境 |
| Kubernetes | 本番環境のオーケストレーション |
| Kustomize | K8sマニフェスト管理 |
| Istio | サービスメッシュ（オプション） |

## プロジェクト構造

```
rust_webapi/
├── src/                      # メインアプリケーションコード
│   ├── main.rs              # エントリーポイント
│   ├── lib.rs               # ライブラリルート
│   ├── app_domain/          # ドメイン層
│   │   ├── model/           # ドメインモデル
│   │   └── repository/      # リポジトリインターフェース
│   ├── application/         # アプリケーション層
│   │   ├── dto/             # データ転送オブジェクト
│   │   └── service/         # ビジネスロジックサービス
│   ├── infrastructure/      # インフラストラクチャ層
│   │   ├── repository/      # リポジトリ実装
│   │   ├── auth/            # 認証・認可
│   │   ├── logger/          # ロギング設定
│   │   ├── metrics/         # メトリクス設定
│   │   └── tracing/         # 分散トレーシング
│   └── presentation/        # プレゼンテーション層
│       └── api/             # HTTPハンドラー
├── crates/                  # サブクレート
│   └── domain/              # 共有ドメインロジック
├── tests/                   # 統合テスト
├── k8s/                     # Kubernetesマニフェスト
│   ├── base/                # 基本設定
│   └── overlays/            # 環境別設定
├── docs/                    # ドキュメント
├── scripts/                 # ユーティリティスクリプト
└── initdb/                  # データベース初期化

```

## アーキテクチャ原則

### ドメイン駆動設計（DDD）

本プロジェクトは、Eric EvansのDDD原則に従い、以下の層構造を採用しています：

1. **ドメイン層**: ビジネスロジックとルールをカプセル化
2. **アプリケーション層**: ユースケースの調整とトランザクション管理
3. **インフラストラクチャ層**: 技術的な実装詳細
4. **プレゼンテーション層**: 外部インターフェース

### SOLID原則

- **単一責任の原則**: 各構造体・モジュールは1つの責任のみを持つ
- **開放閉鎖原則**: トレイトによる拡張可能な設計
- **リスコフの置換原則**: トレイト実装の一貫性
- **インターフェース分離の原則**: 小さく焦点を絞ったトレイト
- **依存性逆転の原則**: 抽象（トレイト）に依存

### 12ファクターアプリ

- **コードベース**: Gitによるバージョン管理
- **依存関係**: Cargo.tomlで明示的に宣言
- **設定**: 環境変数による設定
- **バックエンドサービス**: データベースなどはアタッチされたリソースとして扱う
- **ビルド、リリース、実行**: CI/CDパイプラインで分離
- **プロセス**: ステートレスなプロセス
- **ポートバインディング**: 環境変数PORTで設定可能
- **並行性**: 水平スケーリング対応
- **廃棄容易性**: グレースフルシャットダウン実装
- **開発/本番の一致**: Dockerによる環境の統一
- **ログ**: 標準出力への構造化ログ
- **管理プロセス**: マイグレーションなどは別プロセスで実行

## 主要機能

### 商品管理システム

- **基本CRUD操作**: 商品の作成、読取、更新、削除
- **論理削除と物理削除**: ソフトデリートと完全削除の両方をサポート
- **バッチ処理**: 複数商品の一括操作
- **履歴管理**: 全ての変更履歴を記録
- **在庫管理**: リアルタイム在庫追跡と予約システム
- **価格管理**: 複数通貨、時間ベースの価格設定
- **画像管理**: 商品画像の管理とソート

### カテゴリ管理

- **階層構造**: 親子関係によるカテゴリツリー
- **柔軟な分類**: 商品の複数カテゴリ割り当て
- **動的な管理**: カテゴリの追加、編集、削除

### ユーザー管理

- **認証**: JWT/Keycloakによるセキュアな認証
- **認可**: ロールベースのアクセス制御
- **プロファイル管理**: ユーザー情報の管理

### 可観測性

- **ヘルスチェック**: `/api/health`エンドポイント
- **メトリクス**: Prometheusフォーマットでのメトリクス公開
- **構造化ログ**: JSONフォーマットでの詳細ログ
- **分散トレーシング**: リクエストの追跡とパフォーマンス分析

## 開発環境

### 必要条件

- Rust 1.77以上
- Docker & Docker Compose
- PostgreSQL 15以上（Dockerで提供）
- 推奨: VS Code + rust-analyzer

### セットアップ手順

1. リポジトリのクローン
```bash
git clone https://github.com/your-org/rust-webapi.git
cd rust-webapi
```

2. 環境変数の設定
```bash
cp .env.example .env
# .envファイルを編集して適切な値を設定
```

3. Docker Composeで起動
```bash
docker-compose up -d
```

4. 動作確認
```bash
curl http://localhost:8080/api/health
```

## 本番環境へのデプロイ

### Kubernetes

```bash
# 基本デプロイ
kubectl apply -k k8s/base

# 環境別デプロイ
kubectl apply -k k8s/overlays/production
```

### CI/CD

- GitHub Actions / GitLab CI / Jenkins対応
- 自動テスト実行
- Dockerイメージのビルドとプッシュ
- Kubernetesへの自動デプロイ

## 性能特性

- **レスポンスタイム**: 平均 < 50ms
- **スループット**: 10,000+ req/sec（8コア環境）
- **起動時間**: < 1秒
- **メモリ使用量**: < 100MB（アイドル時）

## セキュリティ

- JWT認証による安全なAPI保護
- HTTPS/TLSによる通信の暗号化
- SQLインジェクション対策（プリペアドステートメント）
- 環境変数による機密情報管理
- 定期的な依存関係の更新

## ライセンス

MIT License - 詳細は[LICENSE](../LICENSE)ファイルを参照してください。